# ğŸŒ [order_cus_sel_geo_wide] æ•°æ®é›†è¯´æ˜

## ä¸€ã€ä¸»é¢˜ç®€ä»‹ï¼ˆPurposeï¼‰

æœ¬æ•°æ®é›†ä¸º **â€œè®¢å•åœ°ç†æ‰©å±•ä¸»é¢˜â€**ï¼Œç”¨äºåˆ†æ **åœ°ç†è·ç¦»å¯¹å±¥çº¦æ—¶æ•ˆçš„å½±å“**ã€‚
é€šè¿‡å°†è®¢å•ã€ä¹°å®¶ã€å–å®¶ä¸åœ°ç†ä½ç½®è¡¨è¿›è¡Œæ•´åˆï¼Œæ„å»ºåŒ…å« **ç»çº¬åº¦ä¸è·ç¦»ç‰¹å¾** çš„å®½è¡¨ï¼Œå¯ç”¨äºä»¥ä¸‹åˆ†æä»»åŠ¡ï¼š

* ğŸ“¦ åˆ†æä¸åŒåœ°ç†è·ç¦»åŒºé—´ï¼ˆå¦‚åŒåŸã€è·¨å·ï¼‰å¯¹å±¥çº¦å¤©æ•°çš„å½±å“
* â±ï¸ è®¡ç®— OTDâ‰¤5 å æ¯”ã€P50/P90 ç­‰æŒ‡æ ‡ï¼Œè¯„ä¼°å¹³å°å±¥çº¦æ•ˆç‡
* ğŸšš è¾…åŠ©å·®è¯„ã€å»¶è¿Ÿå‘è´§ã€å±¥çº¦ä½“éªŒç›¸å…³å»ºæ¨¡

---

## äºŒã€æ•°æ®æ¥æºï¼ˆSource Tablesï¼‰

| æ¥æºè¡¨                             | è¯´æ˜                   |
| ------------------------------- | -------------------- |
| `order_table_cleaned.csv`       | æ¸…æ´—åçš„è®¢å•ä¸»è¡¨ï¼ŒåŒ…å«è®¢å•çŠ¶æ€ä¸å±¥çº¦å¤©æ•° |
| `olist_sellers_dataset.csv`     | å–å®¶åŸºç¡€ä¿¡æ¯è¡¨              |
| `olist_order_items_dataset.csv` | è®¢å•æ˜ç»†è¡¨ï¼Œç”¨äºè¿æ¥å–å®¶ä¸è®¢å•      |
| `olist_customers_dataset.csv`   | ä¹°å®¶ä¿¡æ¯è¡¨                |
| `olist_geolocation_dataset.csv` | åœ°ç†è¡¨ï¼ŒåŒ…å«é‚®ç¼–ã€ç»çº¬åº¦ä¿¡æ¯       |

---

## ä¸‰ã€ä¸»è¦å­—æ®µè¯´æ˜ï¼ˆSchemaï¼‰

| å­—æ®µå               | ç±»å‹       | æ¥æº                      | è¯´æ˜                        |
| ----------------- | -------- | ----------------------- | ------------------------- |
| `order_id`        | string   | order_table_cleaned     | è®¢å•å”¯ä¸€æ ‡è¯†                    |
| `days`            | int      | order_table_cleaned     | å±¥çº¦å¤©æ•°                      |
| `customer_state`  | string   | olist_customers_dataset | ä¹°å®¶æ‰€åœ¨å·                     |
| `seller_state`    | string   | olist_sellers_dataset   | å–å®¶æ‰€åœ¨å·                     |
| `distance_km`     | float    | geoè®¡ç®—ç”Ÿæˆ                 | ä¹°å–åŒæ–¹è·ç¦»ï¼ˆå…¬é‡Œï¼‰                |
| `distance_bucket` | category | ç‰¹å¾å·¥ç¨‹                    | è·ç¦»åˆ†æ¡¶ï¼ˆå¦‚ `<100`, `100â€“500`ï¼‰ |

---

## å››ã€ETLé€»è¾‘ï¼ˆProcessing Stepsï¼‰

### ğŸ§© ETL Pipeline ç»“æ„

æ•´ä¸ªæµç¨‹é‡‡ç”¨ **Extract â†’ Transform â†’ Load** ä¸‰æ­¥æ¨¡å¼ï¼š

```bash
etl_pipeline(list_path)
```

### 1ï¸âƒ£ Extract é˜¶æ®µ

* ä» `../raw` ç›®å½•è¯»å– 5 å¼ åŸå§‹æ•°æ®è¡¨ï¼›
* è‹¥æ–‡ä»¶ç¼ºå¤±åˆ™è‡ªåŠ¨è®°å½•æ—¥å¿—å¹¶ä¸­æ­¢æµç¨‹ï¼›
* è¾“å‡ºåŠ è½½è¡Œåˆ—æ•°ä»¥ä¾¿ç›‘æ§æ•°æ®å®Œæ•´æ€§ã€‚

### 2ï¸âƒ£ Transform é˜¶æ®µ

ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š

| æ­¥éª¤       | è¯´æ˜                                                      |
| -------- | ------------------------------------------------------- |
| â‘  æ•°æ®ç­›é€‰   | è¿‡æ»¤ `delivered` çŠ¶æ€è®¢å•ï¼Œä¿ç•™å±¥çº¦å¤©æ•° 0â€“180 å¤©ä¹‹é—´çš„æ•°æ®                 |
| â‘¡ å»é‡     | åœ¨è®¢å•æ˜ç»†è¡¨ä¸­æŒ‰ `order_id` å»é‡ï¼Œä»…ä¿ç•™é¦–ä¸ªè®°å½•                          |
| â‘¢ ç»çº¬åº¦å‡å€¼åŒ– | å¯¹ç›¸åŒé‚®ç¼–çš„ç»çº¬åº¦å–å‡å€¼ï¼Œå‡å°‘åœ°ç†å™ªå£°                                     |
| â‘£ åœ°ç†ä¿¡æ¯åˆå¹¶ | ä¾æ¬¡å°†ä¹°å®¶ã€å–å®¶ä¸åœ°ç†è¡¨å·¦è¿æ¥ï¼Œç”Ÿæˆå«ç»çº¬åº¦å­—æ®µçš„å®½è¡¨                             |
| â‘¤ ç¼ºå¤±å€¼åˆ é™¤  | åˆ é™¤æ— æ³•åŒ¹é…åœ°ç†ç¼–ç çš„è®°å½•                                           |
| â‘¥ è·ç¦»è®¡ç®—   | ä½¿ç”¨ Haversine å…¬å¼è®¡ç®—ä¹°å–åŒæ–¹è·ç¦»ï¼ˆå•ä½ kmï¼‰                          |
| â‘¦ åˆ†æ¡¶     | æŒ‰è·ç¦»åŒºé—´ `[0,100,500,1000,2000,âˆ)` æ„é€  `distance_bucket` å­—æ®µ |

### 3ï¸âƒ£ Load é˜¶æ®µ

* è¾“å‡ºç»“æœä¿å­˜è‡³ï¼š

  ```
  ../processed/order_cus_sel_geo_wide.csv
  ```
* å¹¶åœ¨ `etl.log` ä¸­è®°å½•æ•°æ®è´¨é‡æŠ¥å‘Šï¼ˆç¼ºå¤±ç‡ã€é‡å¤ç‡ç­‰ï¼‰ã€‚

---

## äº”ã€SQL åˆ†æç¤ºä¾‹ï¼ˆAnalysis Exampleï¼‰

ä»¥ä¸‹ SQL å¯ç”¨äºè¯„ä¼°ä¸åŒè·ç¦»åŒºé—´çš„å±¥çº¦è¡¨ç°ï¼š

```sql
WITH base AS (
  SELECT
    order_id,
    days,
    distance_bucket AS è·ç¦»åŒºé—´,
    PERCENT_RANK() OVER (ORDER BY days) AS pct_rank
  FROM order_cus_sel_geo_wide
)
SELECT
  è·ç¦»åŒºé—´,
  COUNT(order_id) AS è®¢å•é‡,
  ROUND(AVG(days), 2) AS å¹³å‡æ—¶é•¿,
  ROUND(SUM(days <= 5) * 100.0 / COUNT(*), 2) AS otd_le_5_pct,
  ROUND(SUM(days > 30) * 100.0 / COUNT(*), 2) AS gt_30_pct,
  MIN(CASE WHEN pct_rank >= 0.5 THEN days END) AS P50_days,
  MIN(CASE WHEN pct_rank >= 0.9 THEN days END) AS P90_days
FROM base
GROUP BY è·ç¦»åŒºé—´;
```

ğŸ‘‰ è¾“å‡ºç»“æœå¯ç”¨äºå¯è§†åŒ–ï¼š

* Xè½´ï¼šè·ç¦»åŒºé—´
* Yè½´ï¼šå¹³å‡å±¥çº¦æ—¶é—´æˆ– OTDâ‰¤5 å æ¯”
* ä»è€ŒéªŒè¯â€œè·ç¦»è¶Šè¿œ â†’ å±¥çº¦æ—¶é•¿å¢åŠ â€çš„å‡è®¾ã€‚

---

## å…­ã€æ—¥å¿—ä¸è´¨é‡ç›‘æ§ï¼ˆLogging & QAï¼‰

* æ—¥å¿—æ–‡ä»¶ï¼š`etl.log`
* è¾“å‡ºç¤ºä¾‹ï¼š

  ```
  [DATA QUALITY] åˆå¹¶åæ•°æ® - è¡Œæ•°: 87321 | åˆ—æ•°: 10 | ç¼ºå¤±ç‡: 0.00% | é‡å¤ç‡: 0.00%
  [LOAD] æ•°æ®å·²ä¿å­˜è‡³ ../processed/order_cus_sel_geo_wide.csv
  ```

---

## ä¸ƒã€æ–‡ä»¶ç»“æ„ï¼ˆFile Structureï¼‰

```
order_cus_sel_geo_wide/
â”‚
â”œâ”€â”€ raw/                    # åŸå§‹æ•°æ®
â”‚   â”œâ”€â”€ order_table_cleaned.csv
â”‚   â”œâ”€â”€ olist_sellers_dataset.csv
â”‚   â”œâ”€â”€ olist_order_items_dataset.csv
â”‚   â”œâ”€â”€ olist_customers_dataset.csv
â”‚   â””â”€â”€ olist_geolocation_dataset.csv
â”‚
â”œâ”€â”€ processed/              # å¤„ç†åçš„è¾“å‡ºæ–‡ä»¶
â”‚   â””â”€â”€ order_cus_sel_geo_wide.csv
â”‚
â”œâ”€â”€ etl.log                 # æ—¥å¿—æ–‡ä»¶ï¼ˆè¿è¡Œæ—¶è‡ªåŠ¨ç”Ÿæˆï¼‰
â””â”€â”€ etl_geo_wide.py         # å½“å‰ETLè„šæœ¬
```

---

## å…«ã€æŒ‡æ ‡è§£é‡Šï¼ˆMetricsï¼‰

| æŒ‡æ ‡            | å«ä¹‰                 |
| ------------- | ------------------ |
| **OTDâ‰¤5**     | å±¥çº¦æ—¶é—´å°äºç­‰äº5å¤©çš„è®¢å•å æ¯”    |
| **P50 / P90** | å±¥çº¦å¤©æ•°çš„50åˆ†ä½æ•° / 90åˆ†ä½æ•° |
| **avg_days**  | å¹³å‡å±¥çº¦æ—¶é—´             |
| **gt_30_pct** | å±¥çº¦è¶…30å¤©è®¢å•å æ¯”         |

